<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script> 
  </head>
  <body>
    <h1><%= title %></h1>
    <p>Welcome to <%= title %></p>

    <div class='dlogin'>
      <form class='login'>
      Email<input type="text" name='email' value='ddmail2009@gmail.com'>
      Password<input type="password" name='password' value='asd'>
      <button id='login'>Submit</button>
      </form>
    </div>

    <div class='dlogout'>
      <form class='logout'>
      <button id='logout'>logout</button>
      </form>
    </div>

    <div class='dstatus'>
      <form class='getlist'>
      <button>getstatus</button>
      </form>
      <div class='status'></div>
    </div>

    <div class='dmodify'>
      <form class='modify'>
        input data you want to modified in JSON format<br/>
        ex. {"language":["english", "chinese", 2]}
        <input type='text' name='modify' id='modify_item' value='{"language":["english", "chinese", 2]}'>
        <button>modify</button>
      </form>
    </div>

    <button id='www'>FB</button>
    <button id='FBpush'>FBPUSH</button>
    <button id="collect">COLLECTION</button><br/>

    <input type="text" name='id' id='save_list'>
    <button id='collect_save'>collection SAVE</button>

<script>
  $('#collect_save').click(function(){
    $.post('/'+id+'/save', {token:token, id:$('#save_list').val()},function(data){
      console.log(data);
    }, 'text');
  })

  $("#collect").click(function(){
    $.post('/'+id+'/collection_list', {token:token}, function(data){
      console.log(data);
    }, 'text');
  })

  window.fbAsyncInit = function() {
    FB.init({
      appId      : '471817496195401', // App ID from the App Dashboard
      // channelUrl : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File for x-domain communication
      status     : true, // check the login status upon init?
      cookie     : true, // set sessions cookies to allow your server to access the session?
      xfbml      : true  // parse XFBML tags on this page?
    });

  };

  (function(d, debug){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all" + (debug ? "/debug" : "") + ".js";
     ref.parentNode.insertBefore(js, ref);
   }(document, /*debug*/ false));

      var token = null;
      var id = null;

      var temp = {};
      $('#www').click(function(){
        FB.login(function(response) {
          if (response.authResponse) {
            console.log('Welcome!  Fetching your information.... ');
            FB.api('/me?fields=bio,birthday,education,work', function(response) {
              console.log(response);
              console.log(response['education']);
              for (i in response['education']){
                if( response['education'][i]['type'] == 'College' || response['education'][i]['type'] == 'Graduate School' ){
                  console.log(response['education'][i]['school']['name'])
                  temp['School'] = response['education'][i]['school']['name'];
                }
              }
              temp['Job_exp'] = JSON.stringify(response['work'][0]);
            });
          } else console.log('User cancelled login or did not fully authorize.');
        });
      })

      $('#FBpush').click(function(){
        console.log('FBpush!!!');
        temp['token'] = token;
        $.post('/'+id+'/modify', temp, function(message){
          console.log(message);
        })
      })

      $('.modify').submit(function(){
        try{
          var data = JSON.parse($('#modify_item').val());
          data['token'] = token;
          console.log(data);
          $.post('./'+id+'/modify', data, function(message){
            console.log(message);
          }, 'text')
        }
        catch(err){
          console.log(err);
          console.log('can"t understand midify item')
        }
        return false;
      })

      $('.getlist').submit(function(){
        $.post("./"+id+'/status', {token: token}, function(data){
          console.log(data);
          $('.status').html(data);
        }, 'text');
        return false;
      })

      $('.login').submit(function(){
        var data = {email:$("input[name=email]").val(), password:$('input[name="password"]').val()};
        $.post("./login", data, function(data){
          token = JSON.parse(data).token;
          id = JSON.parse(data).id;
          console.log(data);
        }, "text");
        return false;
      });

      $('.logout').submit(function(){
        $.post('./logout', {token: token}, function(data){
          console.log(data);
        }, 'text')
        return false;
      });

    </script>
  </body>
</html>